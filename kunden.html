                <!DOCTYPE html>
<html lang="de">
<head>
    <script>
        if (!sessionStorage.getItem('authKey')) {
            window.location.replace('index.html');
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agenda 2050 | Datenbank</title>
    <link rel="stylesheet" href="style.css">
    <script src="app.js" defer></script>
    <style>
        #lightbox {
            display: none; position: fixed; z-index: 6000;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); justify-content: center; align-items: center;
            cursor: zoom-out; backdrop-filter: blur(10px);
        }
        #lightbox img { max-width: 90%; max-height: 90%; border-radius: 15px; box-shadow: 0 0 50px rgba(5, 217, 232, 0.5); border: 2px solid var(--neon-cyan); }
        
        .img-controls { display: flex; gap: 15px; margin-top: 10px; }
        .icon-btn {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(5, 217, 232, 0.3);
            color: white; width: 38px; height: 38px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; font-size: 1rem; transition: 0.3s;
        }
        .icon-btn:hover { background: var(--neon-cyan); color: black; box-shadow: 0 0 15px var(--neon-cyan); }
        .icon-btn.delete:hover { background: #ff2a6d; color: white; border-color: #ff2a6d; box-shadow: 0 0 15px #ff2a6d; }

        .control-bar {
            display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;
            background: rgba(5, 217, 232, 0.05); padding: 15px; border-radius: 12px;
            border: 1px solid rgba(5, 217, 232, 0.1); align-items: center;
        }
        .view-toggle, .sort-select {
            background: rgba(0,0,0,0.4); border: 1px solid var(--glass-border);
            color: var(--neon-cyan); padding: 8px 12px; border-radius: 8px;
            font-family: inherit; cursor: pointer; transition: 0.3s;
        }
        .view-toggle:hover { background: rgba(5, 217, 232, 0.1); }

        .badge-ao { color: #ffcc00; border-color: #ffcc00; }
        .badge-save { color: #00ff00; border-color: #00ff00; }
        .badge-preis { color: var(--neon-gold); border-color: var(--neon-gold); }
    </style>
</head>
<body>

    <div class="loader-container" id="app-loader">
        <div class="cyber-spinner"></div>
        <div class="loader-text">ACCESSING DB...</div>
    </div>

    <div id="lightbox" onclick="this.style.display='none'">
        <img id="lightboxImg" src="">
    </div>

    <div class="dashboard">
        <div class="btn-cyber btn-settings" onclick="location.href='woche.html'">‚¨ÖÔ∏è</div>
        <div class="header-info">
            <div class="titel-neon">Datenbank</div>
            <div class="countdown-pulsing" id="kunden-counter">0 Profile</div>
        </div>
        <div class="btn-cyber btn-add" onclick="openKundeModal()">+</div>
    </div>

    <div class="kunden-container">
        <input type="text" id="kundenSuche" class="search-bar" placeholder="Kunden durchsuchen..." onkeyup="renderKunden()">
        
        <div class="control-bar">
            <div style="flex-grow: 1; font-size: 0.8rem; color: #888; text-transform: uppercase; letter-spacing: 1px;">Anzeige-Filter:</div>
            
            <select id="sortSelect" class="sort-select" onchange="renderKunden()">
                <option value="name">Sortieren: A-Z</option>
                <option value="status">VIP zuerst</option>
                <option value="vibe">Beste Bewertung (Vibe)</option>
                <option value="perf">Beste Performance</option>
            </select>

            <button id="viewToggleBtn" class="view-toggle" onclick="toggleViewMode()">üñºÔ∏è Karten</button>
        </div>

        <div class="kunden-liste" id="kundenListe"></div>
    </div>

    <div class="modal-overlay" id="kundeModal">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <div class="form-title" id="kundeModalTitle">Profil bearbeiten</div>
            
            <div style="display: flex; justify-content: center; gap: 40px; margin-bottom: 30px;">
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <div id="preview1" onclick="handleImageClick(1)" style="cursor: pointer; width: 100px; height: 100px; border-radius: 50%; border: 2px solid var(--neon-cyan); box-shadow: 0 0 15px rgba(5,217,232,0.3); background-size: cover; background-position: center; display: flex; justify-content: center; align-items: center; color: var(--neon-cyan); font-size: 1.8rem; font-weight: bold; background-color: rgba(5,217,232,0.05);">1</div>
                    <input type="file" id="file1" accept="image/*" onchange="uploadImage(event, 1)" style="display: none;">
                    <div id="controls1" class="img-controls" style="display: none;">
                        <div class="icon-btn" onclick="document.getElementById('file1').click()" title="√Ñndern">‚úèÔ∏è</div>
                        <div class="icon-btn delete" onclick="removeImageWithConfirm(1)" title="L√∂schen">üóëÔ∏è</div>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; align-items: center;">
                    <div id="preview2" onclick="handleImageClick(2)" style="cursor: pointer; width: 100px; height: 100px; border-radius: 50%; border: 2px solid var(--neon-cyan); box-shadow: 0 0 15px rgba(5,217,232,0.3); background-size: cover; background-position: center; display: flex; justify-content: center; align-items: center; color: var(--neon-cyan); font-size: 1.8rem; font-weight: bold; background-color: rgba(5,217,232,0.05);">2</div>
                    <input type="file" id="file2" accept="image/*" onchange="uploadImage(event, 2)" style="display: none;">
                    <div id="controls2" class="img-controls" style="display: none;">
                        <div class="icon-btn" onclick="document.getElementById('file2').click()" title="√Ñndern">‚úèÔ∏è</div>
                        <div class="icon-btn delete" onclick="removeImageWithConfirm(2)" title="L√∂schen">üóëÔ∏è</div>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <div class="form-group" style="flex: 2; min-width: 200px;">
                    <label class="input-label">Name</label>
                    <input type="text" id="kundeName" class="cyber-input-full" placeholder="John Doe">
                </div>
                <div class="form-group" style="flex: 1; min-width: 130px;">
                    <label class="input-label">Status</label>
                    <select id="kundeStatus" class="cyber-select"></select>
                </div>
            </div>

            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <div class="form-group" style="flex: 1; min-width: 120px;">
                    <label class="input-label">Plattform</label>
                    <select id="kundePlattform" class="cyber-select"></select>
                </div>
                <div class="form-group" style="flex: 2; min-width: 200px;">
                    <label class="input-label">Kontakt / Nummer</label>
                    <input type="text" id="kundeKontakt" class="cyber-input-full" placeholder="@username / Nummer">
                </div>
            </div>

            <div style="display: flex; gap: 15px; flex-wrap: wrap; background: rgba(5, 217, 232, 0.05); padding: 15px; border-radius: 12px; border: 1px dashed rgba(5,217,232,0.3); margin-bottom: 15px;">
                <div class="form-group" style="flex: 1; min-width: 120px; margin-bottom: 0;">
                    <label class="input-label" style="color: var(--neon-gold);">Preis (‚Ç¨)</label>
                    <input type="number" id="kundePreis" class="cyber-input-full" placeholder="z.B. 150">
                </div>
                <div class="form-group" style="flex: 1; min-width: 120px; margin-bottom: 0;">
                    <label class="input-label" style="color: var(--neon-violet);">Pr√§ferenz</label>
                    <select id="kundePraeferenz" class="cyber-select">
                        <option value="none">Keine Angabe</option>
                        <option value="AO">AO (Alles ohne)</option>
                        <option value="Save">Save (Mit Schutz)</option>
                    </select>
                </div>
            </div>

            <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 10px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; border: 1px dashed rgba(5,217,232,0.2);">
                <div class="form-group" style="flex: 1; min-width: 120px; margin-bottom: 0;">
                    <label class="input-label">Ausstattung</label>
                    <select id="kundeGroesse" class="cyber-select">
                        <option value="Unbekannt">Unbekannt</option>
                        <option value="Klein">Klein</option>
                        <option value="Mittel">Mittel</option>
                        <option value="Gro√ü">Gro√ü</option>
                    </select>
                </div>

                <div class="form-group" style="flex: 1; min-width: 140px; margin-bottom: 0;">
                    <label class="input-label">Vibe / Charakter</label>
                    <div class="rating-container">
                        <input type="radio" id="v5" name="vibe" value="5"><label for="v5">‚òÖ</label>
                        <input type="radio" id="v4" name="vibe" value="4"><label for="v4">‚òÖ</label>
                        <input type="radio" id="v3" name="vibe" value="3"><label for="v3">‚òÖ</label>
                        <input type="radio" id="v2" name="vibe" value="2"><label for="v2">‚òÖ</label>
                        <input type="radio" id="v1" name="vibe" value="1"><label for="v1">‚òÖ</label>
                    </div>
                </div>

                <div class="form-group" style="flex: 1; min-width: 140px; margin-bottom: 0;">
                    <label class="input-label">Performance</label>
                    <div class="rating-container">
                        <input type="radio" id="p5" name="perf" value="5"><label for="p5">‚òÖ</label>
                        <input type="radio" id="p4" name="perf" value="4"><label for="p4">‚òÖ</label>
                        <input type="radio" id="p3" name="perf" value="3"><label for="p3">‚òÖ</label>
                        <input type="radio" id="p2" name="perf" value="2"><label for="p2">‚òÖ</label>
                        <input type="radio" id="p1" name="perf" value="1"><label for="p1">‚òÖ</label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="input-label">Vorlieben & Besonderheiten</label>
                <textarea id="kundeVorlieben" class="cyber-input-full" rows="3" placeholder="Was mag er besonders?"></textarea>
            </div>

            <div class="form-group">
                <label class="input-label">Allgemeine Notizen</label>
                <textarea id="kundeNotizen" class="cyber-input-full" rows="3" placeholder="Wichtige Fakten..."></textarea>
            </div>

            <button class="btn-save" onclick="saveKunde()">PROFIL SPEICHERN</button>
            <button onclick="closeKundeModal()" style="width:100%; background:none; border:none; color:#666; padding:15px; cursor:pointer; text-transform:uppercase; letter-spacing:2px; font-weight:bold;">Abbrechen</button>
        </div>
    </div>

    <script>
        let editKundeId = null;
        let imgData = { bild1: '', bild2: '' };
        let viewMode = localStorage.getItem('dbViewMode') || 'grid';

        function toggleViewMode() {
            viewMode = (viewMode === 'grid' ? 'list' : 'grid');
            localStorage.setItem('dbViewMode', viewMode);
            updateViewUI();
            renderKunden();
        }

        function updateViewUI() {
            const btn = document.getElementById('viewToggleBtn');
            const liste = document.getElementById('kundenListe');
            if (viewMode === 'list') {
                btn.innerText = "üìÑ Liste";
                liste.classList.add('list-mode');
            } else {
                btn.innerText = "üñºÔ∏è Karten";
                liste.classList.remove('list-mode');
            }
        }

        function handleImageClick(num) {
            if (imgData['bild' + num]) {
                document.getElementById('lightboxImg').src = imgData['bild' + num];
                document.getElementById('lightbox').style.display = 'flex';
            } else {
                document.getElementById('file' + num).click();
            }
        }

        function uploadImage(event, num) {
            const file = event.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                imgData['bild' + num] = e.target.result;
                updateImageUI(num);
            };
            reader.readAsDataURL(file);
        }

        function removeImageWithConfirm(num) {
            if (confirm("SYSTEM-WARNUNG: Dieses Bild wirklich l√∂schen?")) {
                imgData['bild' + num] = '';
                updateImageUI(num);
                document.getElementById('file' + num).value = '';
            }
        }

        function updateImageUI(num) {
            const preview = document.getElementById('preview' + num);
            const controls = document.getElementById('controls' + num);
            if (imgData['bild' + num]) {
                preview.style.backgroundImage = `url('${imgData['bild' + num]}')`;
                preview.innerText = '';
                controls.style.display = 'flex';
            } else {
                preview.style.backgroundImage = 'none';
                preview.innerText = num;
                controls.style.display = 'none';
            }
        }

        function getStarString(count) {
            let num = parseInt(count) || 0;
            if (num < 0) num = 0;
            if (num > 5) num = 5;
            let filled = "<span style='color:var(--neon-gold); text-shadow: 0 0 5px var(--neon-gold);'>" + "‚òÖ".repeat(num) + "</span>";
            let empty = "<span style='color:#333;'>" + "‚òÖ".repeat(5-num) + "</span>";
            return filled + empty;
        }

        function renderKunden() {
            let kunden = [];
            try {
                kunden = JSON.parse(localStorage.getItem('appKunden')) || [];
            } catch(e) { console.error("DB Error", e); }
            
            const settings = JSON.parse(localStorage.getItem('appEinstellungen')) || {};
            const liste = document.getElementById('kundenListe');
            const search = document.getElementById('kundenSuche').value.toLowerCase();
            const sortBy = document.getElementById('sortSelect').value;
            
            liste.innerHTML = '';
            
            // 1. Filtern (KUGELSICHER: Ignoriert defekte/leere Eintr√§ge)
            let filtered = kunden.filter(k => {
                if (!k || !k.name) return false; // Schutzschild
                const searchName = k.name.toLowerCase();
                const searchKontakt = k.kontakt ? k.kontakt.toLowerCase() : '';
                return searchName.includes(search) || searchKontakt.includes(search);
            });

            // 2. Sortieren
            filtered.sort((a, b) => {
                if (sortBy === 'name') return (a.name || '').localeCompare(b.name || '');
                if (sortBy === 'status') {
                    const order = { 'kat1': 1, 'kat2': 2, 'kat3': 3, 'none': 4 };
                    return (order[a.status] || 99) - (order[b.status] || 99);
                }
                if (sortBy === 'vibe') return (parseInt(b.vibe) || 0) - (parseInt(a.vibe) || 0);
                if (sortBy === 'perf') return (parseInt(b.perf) || 0) - (parseInt(a.perf) || 0);
                return 0;
            });

            // 3. Karten zeichnen
                filtered.forEach(k => {
                const avatarImg = k.bild1 ? `background-image:url('${k.bild1}'); background-size:cover; background-position:center;` : "";
                const avatarText = k.bild1 ? "" : (k.name ? k.name.substring(0,2).toUpperCase() : "??");
                
                let badgeHTML = (k.status && k.status !== 'none') ? `<span class="status-badge status-${k.status}">${settings[k.status + '_name'] || 'Status'}</span>` : '';

                let praeferenzBadge = '';
                if (k.praeferenz === 'AO') praeferenzBadge = `<div class="stat-badge badge-ao">AO</div>`;
                else if (k.praeferenz === 'Save') praeferenzBadge = `<div class="stat-badge badge-save">Save</div>`;

                let preisBadge = k.preis ? `<div class="stat-badge badge-preis">üí∞ ${k.preis}‚Ç¨</div>` : '';

                liste.innerHTML += `
                    <div class="kunden-karte" onclick="openKundeModal(${k.id})">
                        <button class="btn-delete-kunde" onclick="event.stopPropagation(); deleteKunde(${k.id})">‚úñ</button>
                        <div class="kunden-avatar" style="${avatarImg} border-radius: 50%; border: 2px solid var(--neon-cyan);">${avatarText}</div>
                        <div class="kunden-info">
                            <div style="flex-grow: 1;">
                                <div class="kunden-name">${k.name} ${badgeHTML}</div>
                                <div class="kunden-kontakt" style="font-size: 0.85rem; opacity: 0.7; margin-top: 2px;">${k.plattform !== 'none' && k.plattform ? k.plattform + ': ' : ''}${k.kontakt || ''}</div>
                            </div>
                            
                            <div class="kunden-stats-row">
                                ${preisBadge}
                                ${praeferenzBadge}
                                <div class="stat-badge">üìê ${k.groesse || '?'}</div>
                                <div class="stat-badge">V: ${getStarString(k.vibe)}</div>
                                <div class="stat-badge">P: ${getStarString(k.perf)}</div>
                            </div>
                            
                            ${k.vorlieben && viewMode === 'grid' ? `<div class="kunden-notiz" style="border-left-color:var(--neon-violet); margin-top:10px;"><strong>Vorlieben:</strong> ${k.vorlieben}</div>` : ''}
                        </div>
                    </div>`;
            });
            document.getElementById('kunden-counter').innerText = filtered.length + (filtered.length === 1 ? ' Profil' : ' Profile');
        }

        function openKundeModal(id = null) {
            editKundeId = id;
            ladeModalEinstellungen();
            if (id) {
                const k = (JSON.parse(localStorage.getItem('appKunden')) || []).find(x => x.id === id);
                if(k) {
                    document.getElementById('kundeModalTitle').innerText = "Profil bearbeiten";
                    document.getElementById('kundeName').value = k.name || '';
                    document.getElementById('kundeStatus').value = k.status || 'none';
                    document.getElementById('kundePlattform').value = k.plattform || 'none';
                    document.getElementById('kundeKontakt').value = k.kontakt || '';
                    document.getElementById('kundePreis').value = k.preis || '';
                    document.getElementById('kundePraeferenz').value = k.praeferenz || 'none';
                    document.getElementById('kundeGroesse').value = k.groesse || 'Unbekannt';
                    
                    document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
                    if(k.vibe > 0) document.getElementById('v'+k.vibe).checked = true;
                    if(k.perf > 0) document.getElementById('p'+k.perf).checked = true;

                    document.getElementById('kundeVorlieben').value = k.vorlieben || '';
                    document.getElementById('kundeNotizen').value = k.notizen || '';
                    imgData.bild1 = k.bild1 || ''; imgData.bild2 = k.bild2 || '';
                }
            } else {
                document.getElementById('kundeModalTitle').innerText = "Neues Profil";
                document.getElementById('kundeName').value = '';
                document.getElementById('kundeStatus').value = 'none';
                document.getElementById('kundePlattform').value = 'none';
                document.getElementById('kundeKontakt').value = '';
                document.getElementById('kundePreis').value = '';
                document.getElementById('kundePraeferenz').value = 'none';
                document.getElementById('kundeGroesse').value = 'Unbekannt';
                document.getElementById('kundeVorlieben').value = '';
                document.getElementById('kundeNotizen').value = '';
                imgData.bild1 = ''; imgData.bild2 = '';
                document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
            }
            updateImageUI(1); updateImageUI(2);
            document.getElementById('kundeModal').style.display = 'flex';
        }

        function saveKunde() {
            const name = document.getElementById('kundeName').value;
            if(!name) return alert("Name fehlt!");
            
            let kunden = JSON.parse(localStorage.getItem('appKunden')) || [];
            const data = {
                id: editKundeId || Date.now(),
                name: name,
                status: document.getElementById('kundeStatus').value,
                plattform: document.getElementById('kundePlattform').value,
                kontakt: document.getElementById('kundeKontakt').value,
                preis: document.getElementById('kundePreis').value,
                praeferenz: document.getElementById('kundePraeferenz').value,
                groesse: document.getElementById('kundeGroesse').value,
                vibe: document.querySelector('input[name="vibe"]:checked')?.value || 0,
                perf: document.querySelector('input[name="perf"]:checked')?.value || 0,
                vorlieben: document.getElementById('kundeVorlieben').value,
                notizen: document.getElementById('kundeNotizen').value,
                bild1: imgData.bild1, bild2: imgData.bild2
            };

            if (editKundeId) kunden = kunden.map(k => k.id === editKundeId ? data : k);
            else kunden.push(data);
            
            localStorage.setItem('appKunden', JSON.stringify(kunden));
            closeKundeModal(); renderKunden();
        }

        function deleteKunde(id) {
            if(confirm("Dieses Profil wirklich l√∂schen?")) {
                let k = JSON.parse(localStorage.getItem('appKunden')) || [];
                localStorage.setItem('appKunden', JSON.stringify(k.filter(x => x && x.id !== id)));
                renderKunden();
            }
        }

        function ladeModalEinstellungen() {
            const s = JSON.parse(localStorage.getItem('appEinstellungen')) || { kat1_name:'VIP', kat2_name:'Stamm', kat3_name:'Neu', plat1:'WhatsApp', plat2:'Instagram' };
            document.getElementById('kundeStatus').innerHTML = `<option value="none">Status w√§hlen</option><option value="kat1">${s.kat1_name}</option><option value="kat2">${s.kat2_name}</option><option value="kat3">${s.kat3_name}</option>`;
            document.getElementById('kundePlattform').innerHTML = `<option value="none">Keine</option><option value="${s.plat1}">${s.plat1}</option><option value="${s.plat2}">${s.plat2}</option><option value="${s.plat3 || 'Telegram'}">${s.plat3 || 'Telegram'}</option><option value="${s.plat4 || 'Telefon'}">${s.plat4 || 'Telefon'}</option>`;
        }

        function closeKundeModal() { document.getElementById('kundeModal').style.display = 'none'; }

        window.onload = () => {
            updateViewUI();
            renderKunden();
            setTimeout(() => document.getElementById('app-loader').style.opacity = '0', 400);
            setTimeout(() => document.getElementById('app-loader').style.display = 'none', 900);
        };
    </script>
</body>
</html>
