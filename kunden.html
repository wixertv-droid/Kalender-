<!DOCTYPE html>
<html lang="de">
<head>
    <script>
        if (!sessionStorage.getItem('authKey')) {
            window.location.replace('index.html');
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agenda 2050 | Datenbank</title>
    <link rel="stylesheet" href="style.css">
    <script src="app.js" defer></script>
</head>
<body>

    <div class="loader-container" id="app-loader">
        <div class="cyber-spinner"></div>
        <div class="loader-text">ACCESSING DB...</div>
    </div>

    <div class="dashboard">
        <div class="btn-cyber btn-settings" onclick="location.href='woche.html'">‚¨ÖÔ∏è</div>
        <div class="header-info">
            <div class="titel-neon">Datenbank</div>
            <div class="countdown-pulsing" id="kunden-counter">0 Profile</div>
        </div>
        <div class="btn-cyber btn-add" onclick="openKundeModal()">+</div>
    </div>

    <div class="kunden-container">
        <input type="text" id="kundenSuche" class="search-bar" placeholder="Kunden durchsuchen..." onkeyup="renderKunden()">
        <div class="kunden-liste" id="kundenListe">
            </div>
    </div>

    <div class="modal-overlay" id="kundeModal">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <div class="form-title" id="kundeModalTitle">Neues Profil</div>
            
            <div style="display: flex; justify-content: center; gap: 30px; margin-bottom: 30px;">
                <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                    <label for="file1" class="image-preview" id="preview1" style="cursor: pointer; transition: 0.3s; width: 85px; height: 85px; border-color: var(--neon-cyan); box-shadow: 0 0 15px rgba(5,217,232,0.2);" title="Klicken zum √Ñndern">1</label>
                    <input type="file" id="file1" accept="image/*" onchange="uploadImage(event, 1)" style="display: none;">
                    <button class="btn-delete" style="padding: 4px 10px; font-size: 0.7rem; border-radius: 6px;" onclick="removeImageWithConfirm(1)">L√∂schen</button>
                </div>

                <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                    <label for="file2" class="image-preview" id="preview2" style="cursor: pointer; transition: 0.3s; width: 85px; height: 85px; border-color: var(--neon-cyan); box-shadow: 0 0 15px rgba(5,217,232,0.2);" title="Klicken zum √Ñndern">2</label>
                    <input type="file" id="file2" accept="image/*" onchange="uploadImage(event, 2)" style="display: none;">
                    <button class="btn-delete" style="padding: 4px 10px; font-size: 0.7rem; border-radius: 6px;" onclick="removeImageWithConfirm(2)">L√∂schen</button>
                </div>
            </div>

            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <div class="form-group" style="flex: 2; min-width: 200px;">
                    <label class="input-label">Name</label>
                    <input type="text" id="kundeName" class="cyber-input-full" placeholder="John Doe">
                </div>
                <div class="form-group" style="flex: 1; min-width: 130px;">
                    <label class="input-label">Status</label>
                    <select id="kundeStatus" class="cyber-select"></select>
                </div>
            </div>

            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <div class="form-group" style="flex: 1; min-width: 120px;">
                    <label class="input-label">Plattform</label>
                    <select id="kundePlattform" class="cyber-select"></select>
                </div>
                <div class="form-group" style="flex: 2; min-width: 200px;">
                    <label class="input-label">Kontakt / Nummer</label>
                    <input type="text" id="kundeKontakt" class="cyber-input-full" placeholder="@username / Nummer">
                </div>
            </div>

            <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 10px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; border: 1px dashed rgba(5,217,232,0.2);">
                
                <div class="form-group" style="flex: 1; min-width: 120px; margin-bottom: 0;">
                    <label class="input-label">Ausstattung</label>
                    <select id="kundeGroesse" class="cyber-select" style="padding: 12px; font-size: 1rem;">
                        <option value="Unbekannt">Unbekannt</option>
                        <option value="Klein">Klein</option>
                        <option value="Mittel">Mittel</option>
                        <option value="Gro√ü">Gro√ü</option>
                    </select>
                </div>

                <div class="form-group" style="flex: 1; min-width: 140px; margin-bottom: 0;">
                    <label class="input-label">Vibe / Charakter</label>
                    <div class="rating-container" id="ratingVibe">
                        <input type="radio" id="v5" name="vibe" value="5"><label for="v5">‚òÖ</label>
                        <input type="radio" id="v4" name="vibe" value="4"><label for="v4">‚òÖ</label>
                        <input type="radio" id="v3" name="vibe" value="3"><label for="v3">‚òÖ</label>
                        <input type="radio" id="v2" name="vibe" value="2"><label for="v2">‚òÖ</label>
                        <input type="radio" id="v1" name="vibe" value="1"><label for="v1">‚òÖ</label>
                    </div>
                </div>

                <div class="form-group" style="flex: 1; min-width: 140px; margin-bottom: 0;">
                    <label class="input-label">Performance</label>
                    <div class="rating-container" id="ratingPerf">
                        <input type="radio" id="p5" name="perf" value="5"><label for="p5">‚òÖ</label>
                        <input type="radio" id="p4" name="perf" value="4"><label for="p4">‚òÖ</label>
                        <input type="radio" id="p3" name="perf" value="3"><label for="p3">‚òÖ</label>
                        <input type="radio" id="p2" name="perf" value="2"><label for="p2">‚òÖ</label>
                        <input type="radio" id="p1" name="perf" value="1"><label for="p1">‚òÖ</label>
                    </div>
                </div>

            </div>

            <div class="form-group">
                <label class="input-label">Vorlieben & Besonderheiten</label>
                <textarea id="kundeVorlieben" class="cyber-input-full" placeholder="Was mag er besonders? Tabus? ..." style="min-height: 80px;"></textarea>
            </div>

            <div class="form-group">
                <label class="input-label">Allgemeine Notizen</label>
                <textarea id="kundeNotizen" class="cyber-input-full" placeholder="Sonstige Infos..." style="min-height: 80px; border-left-color: #555;"></textarea>
            </div>

            <button class="btn-save" onclick="saveKunde()">PROFIL SPEICHERN</button>
            <button onclick="closeKundeModal()" style="width: 100%; background: none; border: none; color: #555; font-size: 1rem; padding: 15px; text-transform: uppercase; cursor: pointer; letter-spacing: 2px; margin-top: 10px;">Abbrechen</button>
        </div>
    </div>

    <script>
        let editKundeId = null;
        let imgData = { bild1: '', bild2: '' };

        function ladeModalEinstellungen() {
            const settings = JSON.parse(localStorage.getItem('appEinstellungen')) || {
                kat1_name: 'VIP', kat2_name: 'Stamm', kat3_name: 'Neu',
                plat1: 'WhatsApp', plat2: 'Instagram', plat3: 'Telegram', plat4: 'Telefon'
            };

            const statDrop = document.getElementById('kundeStatus');
            statDrop.innerHTML = `
                <option value="none">Kein Status</option>
                <option value="kat1">${settings.kat1_name}</option>
                <option value="kat2">${settings.kat2_name}</option>
                <option value="kat3">${settings.kat3_name}</option>
            `;

            const platDrop = document.getElementById('kundePlattform');
            platDrop.innerHTML = `
                <option value="none">Keine</option>
                <option value="${settings.plat1}">${settings.plat1}</option>
                <option value="${settings.plat2}">${settings.plat2}</option>
                <option value="${settings.plat3}">${settings.plat3}</option>
                <option value="${settings.plat4}">${settings.plat4}</option>
            `;
            return settings;
        }

        function uploadImage(event, num) {
            const file = event.target.files[0];
            if(!file) return;
            
            if(file.size > 2.5 * 1024 * 1024) {
                alert("SYSTEM-WARNUNG: Bild ist zu gro√ü! Bitte w√§hle ein Bild unter 2.5 MB.");
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                imgData['bild' + num] = e.target.result;
                const preview = document.getElementById('preview' + num);
                preview.style.backgroundImage = `url(${e.target.result})`;
                preview.innerText = ''; 
            };
            reader.readAsDataURL(file);
        }

        function removeImageWithConfirm(num) {
            if (confirm("SYSTEM-WARNUNG: M√∂chtest du dieses Bild wirklich l√∂schen?")) {
                imgData['bild' + num] = '';
                const preview = document.getElementById('preview' + num);
                preview.style.backgroundImage = 'none';
                preview.innerText = num; 
                document.getElementById('file' + num).value = ''; 
            }
        }

        function getStarString(count) {
            if(!count || count === "0") return "Keine Bewertung";
            return "‚òÖ".repeat(parseInt(count)) + "‚òÜ".repeat(5 - parseInt(count));
        }

        function renderKunden() {
            const kunden = JSON.parse(localStorage.getItem('appKunden')) || [];
            const liste = document.getElementById('kundenListe');
            const counter = document.getElementById('kunden-counter');
            const search = document.getElementById('kundenSuche').value.toLowerCase();
            const settings = JSON.parse(localStorage.getItem('appEinstellungen')) || {
                kat1_name: 'VIP', kat2_name: 'Stamm', kat3_name: 'Neu'
            };

            liste.innerHTML = '';
            let count = 0;

            const gefiltert = kunden.filter(k => 
                (k.name && k.name.toLowerCase().includes(search)) || 
                (k.kontakt && k.kontakt.toLowerCase().includes(search))
            ).sort((a, b) => a.name.localeCompare(b.name));

            gefiltert.forEach(k => {
                count++;
                const init = k.name ? k.name.substring(0, 2).toUpperCase() : '??';
                
                let badgeHTML = '';
                if (k.status && k.status !== 'none') {
                    const statusName = settings[k.status + '_name'] || 'Status';
                    badgeHTML = `<span class="status-badge status-${k.status}">${statusName}</span>`;
                }

                let fotosHTML = '';
                if(k.bild1 || k.bild2) {
                    fotosHTML = `<span style="font-size:0.8rem; margin-left: 10px;" title="Bilder hinterlegt">üì∏</span>`;
                }

                const vibeStars = getStarString(k.vibe);
                const perfStars = getStarString(k.perf);
                const groesse = k.groesse && k.groesse !== "Unbekannt" ? k.groesse : "?";

                // Vorlieben Vorschau
                let vorliebenPreview = '';
                if(k.vorlieben && k.vorlieben.trim() !== '') {
                    vorliebenPreview = `<div class="kunden-notiz" style="border-left-color: var(--neon-violet); margin-bottom: 10px;"><strong>Vorlieben:</strong> ${k.vorlieben}</div>`;
                }

                liste.innerHTML += `
                    <div class="kunden-karte" style="cursor: pointer;" onclick="openKundeModal(${k.id})">
                        <button class="btn-delete-kunde" onclick="deleteKunde(event, ${k.id})">‚úñ</button>
                        <div class="kunden-avatar">${init}</div>
                        <div class="kunden-info">
                            <div class="kunden-name">${k.name} ${badgeHTML} ${fotosHTML}</div>
                            <div class="kunden-kontakt">${k.plattform !== 'none' && k.plattform ? k.plattform + ': ' : ''}${k.kontakt || 'Kein Kontakt'}</div>
                            
                            <div class="kunden-stats-row">
                                <div class="stat-badge">üìê ${groesse}</div>
                                <div class="stat-badge">Vibe <span class="stars">${vibeStars}</span></div>
                                <div class="stat-badge">Perf <span class="stars">${perfStars}</span></div>
                            </div>

                            ${vorliebenPreview}
                            <div class="kunden-notiz">${k.notizen || 'Keine Notizen hinterlegt.'}</div>
                        </div>
                    </div>
                `;
            });

            counter.innerText = count === 1 ? '1 Profil' : count + ' Profile';
        }

        // Hilfsfunktion um die Sterne im Formular zu setzen
        function setRadioValue(name, value) {
            const radios = document.getElementsByName(name);
            for(let i=0; i<radios.length; i++) {
                if(radios[i].value === value) { radios[i].checked = true; return; }
            }
            // Reset falls kein Wert
            for(let i=0; i<radios.length; i++) radios[i].checked = false;
        }

        // Hilfsfunktion um die Sterne aus dem Formular auszulesen
        function getRadioValue(name) {
            const radios = document.getElementsByName(name);
            for(let i=0; i<radios.length; i++) {
                if(radios[i].checked) return radios[i].value;
            }
            return "0";
        }

        function openKundeModal(id = null) {
            editKundeId = id;
            ladeModalEinstellungen();

            if (id) {
                const kunden = JSON.parse(localStorage.getItem('appKunden')) || [];
                const k = kunden.find(x => x.id === id);
                if (k) {
                    document.getElementById('kundeModalTitle').innerText = "Profil bearbeiten";
                    document.getElementById('kundeName').value = k.name || '';
                    document.getElementById('kundeStatus').value = k.status || 'none';
                    document.getElementById('kundePlattform').value = k.plattform || 'none';
                    document.getElementById('kundeKontakt').value = k.kontakt || '';
                    
                    document.getElementById('kundeGroesse').value = k.groesse || 'Unbekannt';
                    setRadioValue('vibe', k.vibe || "0");
                    setRadioValue('perf', k.perf || "0");
                    
                    document.getElementById('kundeVorlieben').value = k.vorlieben || '';
                    document.getElementById('kundeNotizen').value = k.notizen || '';
                    
                    imgData.bild1 = k.bild1 || '';
                    imgData.bild2 = k.bild2 || '';
                }
            } else {
                document.getElementById('kundeModalTitle').innerText = "Neues Profil";
                document.getElementById('kundeName').value = '';
                document.getElementById('kundeStatus').value = 'none';
                document.getElementById('kundePlattform').value = 'none';
                document.getElementById('kundeKontakt').value = '';
                
                document.getElementById('kundeGroesse').value = 'Unbekannt';
                setRadioValue('vibe', "0");
                setRadioValue('perf', "0");

                document.getElementById('kundeVorlieben').value = '';
                document.getElementById('kundeNotizen').value = '';
                
                imgData.bild1 = '';
                imgData.bild2 = '';
            }

            for(let i=1; i<=2; i++) {
                const preview = document.getElementById('preview'+i);
                if(imgData['bild'+i]) {
                    preview.style.backgroundImage = `url(${imgData['bild'+i]})`;
                    preview.innerText = '';
                } else {
                    preview.style.backgroundImage = 'none';
                    preview.innerText = i;
                }
            }

            document.getElementById('kundeModal').style.display = 'flex';
        }

        function closeKundeModal() {
            document.getElementById('kundeModal').style.display = 'none';
            editKundeId = null;
        }

        function saveKunde() {
            const name = document.getElementById('kundeName').value;
            const status = document.getElementById('kundeStatus').value; 
            const plattform = document.getElementById('kundePlattform').value;
            const kontakt = document.getElementById('kundeKontakt').value;
            
            const groesse = document.getElementById('kundeGroesse').value;
            const vibe = getRadioValue('vibe');
            const perf = getRadioValue('perf');
            
            const vorlieben = document.getElementById('kundeVorlieben').value;
            const notizen = document.getElementById('kundeNotizen').value;

            if (!name) { alert("Bitte einen Namen eingeben."); return; }

            let kunden = JSON.parse(localStorage.getItem('appKunden')) || [];

            if (editKundeId) {
                const index = kunden.findIndex(k => k.id === editKundeId);
                if (index > -1) {
                    kunden[index].name = name;
                    kunden[index].status = status;
                    kunden[index].plattform = plattform;
                    kunden[index].kontakt = kontakt;
                    kunden[index].groesse = groesse;
                    kunden[index].vibe = vibe;
                    kunden[index].perf = perf;
                    kunden[index].vorlieben = vorlieben;
                    kunden[index].notizen = notizen;
                    kunden[index].bild1 = imgData.bild1;
                    kunden[index].bild2 = imgData.bild2;
                }
            } else {
                kunden.push({
                    id: Date.now(),
                    name: name,
                    status: status,
                    plattform: plattform,
                    kontakt: kontakt,
                    groesse: groesse,
                    vibe: vibe,
                    perf: perf,
                    vorlieben: vorlieben,
                    notizen: notizen,
                    bild1: imgData.bild1,
                    bild2: imgData.bild2
                });
            }

            localStorage.setItem('appKunden', JSON.stringify(kunden));
            closeKundeModal();
            renderKunden();
        }

        function deleteKunde(event, id) {
            event.stopPropagation(); 
            if (confirm("SYSTEM-WARNUNG: Dieses Profil wirklich l√∂schen?")) {
                let kunden = JSON.parse(localStorage.getItem('appKunden')) || [];
                kunden = kunden.filter(k => k.id !== id);
                localStorage.setItem('appKunden', JSON.stringify(kunden));
                renderKunden();
            }
        }

        window.addEventListener('load', () => {
            renderKunden();
            setTimeout(() => {
                const loader = document.getElementById('app-loader');
                if (loader) { loader.style.opacity = '0'; setTimeout(() => loader.remove(), 500); }
            }, 400);
        });
    </script>
</body>
</html>
