<!DOCTYPE html>
<html lang="de">
<head>
    <script>
        if (!sessionStorage.getItem('authKey')) {
            window.location.replace('index.html');
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agenda 2050 | Finance Core</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .stats-container { padding: 20px; display: flex; flex-direction: column; gap: 20px; padding-bottom: 50px; }
        
        /* Jarvis-Style Cards */
        .finance-card {
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            padding: 20px; border-radius: 15px; position: relative; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); min-height: 100px;
        }
        
        .finance-card::after {
            content: ""; position: absolute; top: 0; right: 0; width: 60px; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.03));
            transform: skewX(-45deg) translateX(50px);
        }

        .border-cyan { border-left: 4px solid var(--neon-cyan); }
        .border-violet { border-left: 4px solid var(--neon-violet); }
        .border-gold { border-left: 4px solid var(--neon-gold); }
        .border-green { border-left: 4px solid var(--neon-green); }

        .label { font-size: 0.75rem; color: #aaa; text-transform: uppercase; letter-spacing: 2px; font-weight: bold; }
        .label-highlight { color: var(--neon-cyan); }
        .value { font-size: 2.2rem; font-weight: 900; color: white; margin-top: 5px; text-shadow: 0 0 15px rgba(255,255,255,0.2); font-family: monospace; }
        .sub-info { font-size: 0.85rem; color: #888; margin-top: 10px; border-top: 1px dashed rgba(255,255,255,0.1); padding-top: 10px; display: flex; justify-content: space-between; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        /* =========================================
           NEU: INDIVIDUELLE CYBER-LADEBALKEN
           ========================================= */
        .stat-loader { display: flex; flex-direction: column; justify-content: center; min-height: 80px; padding: 10px 0; }
        .loader-text { font-size: 0.65rem; color: var(--neon-cyan); font-family: monospace; letter-spacing: 2px; margin-bottom: 8px; }
        .loader-track { width: 100%; height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden; position: relative; }
        
        /* Der gestreifte, animierte Bar-Style */
        .loader-fill { 
            height: 100%; width: 0%; border-radius: 4px;
            background-image: repeating-linear-gradient(
                -45deg,
                rgba(255,255,255,0.3) 0,
                rgba(255,255,255,0.3) 10px,
                transparent 10px,
                transparent 20px
            );
            background-color: var(--bar-color);
            background-size: 28px 28px;
            box-shadow: 0 0 10px var(--bar-color);
            animation: fillBar var(--load-time) cubic-bezier(0.1, 0.8, 0.2, 1) forwards, moveStripes 0.8s linear infinite;
        }

        @keyframes fillBar { 0% { width: 0%; } 100% { width: 100%; } }
        @keyframes moveStripes { 0% { background-position: 0 0; } 100% { background-position: 28px 0; } }

        .stat-content { display: none; opacity: 0; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { to { opacity: 1; } }

        /* ========================================= */

        /* Progress Bars (Data Stream - Result) */
        .progress-container { margin-top: 15px; }
        .progress-row { display: flex; align-items: center; margin-bottom: 10px; font-size: 0.85rem; color: #ccc; }
        .progress-name { width: 60px; text-transform: uppercase; font-weight: bold; }
        .progress-track { flex-grow: 1; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; margin: 0 10px; }
        .progress-fill-data { height: 100%; border-radius: 4px; width: 0%; transition: width 1.5s cubic-bezier(0.1, 0.8, 0.2, 1); }
        .progress-value { width: 50px; text-align: right; font-family: monospace; color: white; }

        /* Monthly Breakdown Chart */
        .month-chart { display: flex; justify-content: space-between; align-items: flex-end; height: 120px; margin-top: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; gap: 4px; }
        .month-col { flex: 1; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; height: 100%; position: relative; }
        .month-bar { width: 100%; max-width: 15px; background: var(--neon-violet); border-radius: 3px 3px 0 0; transition: height 1.5s cubic-bezier(0.1, 0.8, 0.2, 1); height: 0; box-shadow: 0 0 10px rgba(188, 0, 221, 0.4); }
        .month-label { font-size: 0.6rem; color: #888; margin-top: 8px; text-transform: uppercase; font-weight: bold; }
        .month-val { font-size: 0.55rem; color: white; margin-bottom: 4px; font-family: monospace; opacity: 0; transition: opacity 1s; position: absolute; top: -20px; text-shadow: 0 0 5px rgba(255,255,255,0.5); }

        /* Terminal Window */
        .terminal {
            background: rgba(5, 15, 25, 0.9); border: 1px solid var(--neon-cyan);
            border-radius: 10px; padding: 15px; font-family: monospace; font-size: 0.8rem;
            color: var(--neon-cyan); box-shadow: inset 0 0 20px rgba(5, 217, 232, 0.1);
            height: 120px; overflow: hidden; position: relative; margin-top: 10px;
        }
        .terminal::before {
            content: "SYSTEM_LOG // ANALYSIS"; position: absolute; top: 0; left: 0; width: 100%;
            background: var(--neon-cyan); color: black; padding: 2px 10px; font-weight: bold; font-size: 0.7rem;
        }
        .terminal-content { margin-top: 15px; display: flex; flex-direction: column; gap: 5px; }
        .log-line { opacity: 0; animation: fadeInLog 0.2s forwards; }
        @keyframes fadeInLog { to { opacity: 1; } }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }

    </style>
</head>
<body>

    <div class="loader-container" id="app-loader">
        <div class="cyber-spinner"></div>
        <div class="loader-text">ACCESSING FINANCE_CORE...</div>
    </div>

    <div class="dashboard">
        <div class="btn-cyber" onclick="location.href='woche.html'">⬅️</div>
        <div class="header-info">
            <div class="titel-neon">FINANCE_CORE</div>
            <div class="datum-anzeige" id="sys-status" style="color: var(--neon-cyan); text-shadow: 0 0 10px var(--neon-cyan);">SYSTEM ONLINE</div>
        </div>
        <div></div>
    </div>

    <div class="stats-container" id="main-container">
        
        <div class="grid-2">
            <div class="finance-card border-cyan">
                <div class="label label-highlight">Current Week</div>
                <div class="stat-loader" id="loader-week">
                    <div class="loader-text blink">DECRYPTING_SECTOR...</div>
                    <div class="loader-track"><div class="loader-fill" style="--bar-color: var(--neon-cyan); --load-time: 0.8s;"></div></div>
                </div>
                <div class="stat-content" id="content-week">
                    <div id="val-week" class="value">0 €</div>
                    <div class="sub-info"><span id="count-week">0 Termine</span><span style="color:var(--neon-cyan);">LIVE</span></div>
                </div>
            </div>
            
            <div class="finance-card border-violet">
                <div class="label" style="color: var(--neon-violet);">Current Month</div>
                <div class="stat-loader" id="loader-month">
                    <div class="loader-text blink" style="color: var(--neon-violet);">ANALYZING_30_DAYS...</div>
                    <div class="loader-track"><div class="loader-fill" style="--bar-color: var(--neon-violet); --load-time: 1.2s;"></div></div>
                </div>
                <div class="stat-content" id="content-month">
                    <div id="val-month" class="value">0 €</div>
                    <div class="sub-info"><span id="count-month">0 Termine</span></div>
                </div>
            </div>
        </div>

        <div class="finance-card border-gold" style="background: rgba(229, 176, 92, 0.05);">
            <div class="label" style="color: var(--neon-gold);">Total Revenue <span id="current-year"></span></div>
            <div class="stat-loader" id="loader-year">
                <div class="loader-text blink" style="color: var(--neon-gold);">AGGREGATING_ANNUAL_DATA...</div>
                <div class="loader-track"><div class="loader-fill" style="--bar-color: var(--neon-gold); --load-time: 1.8s;"></div></div>
            </div>
            <div class="stat-content" id="content-year">
                <div id="val-year" class="value" style="font-size: 3rem; text-shadow: 0 0 20px rgba(229,176,92,0.4);">0 €</div>
                <div class="sub-info"><span id="count-year">0 Abgeschlossen</span></div>
            </div>
        </div>

        <div class="finance-card border-violet">
            <div class="label" style="color: var(--neon-violet);">Monthly Breakdown // Analyse</div>
            <div class="stat-loader" id="loader-chart">
                <div class="loader-text blink" style="color: var(--neon-violet);">RENDERING_VISUAL_MATRIX...</div>
                <div class="loader-track"><div class="loader-fill" style="--bar-color: var(--neon-violet); --load-time: 2.2s;"></div></div>
            </div>
            <div class="stat-content" id="content-chart">
                <div class="month-chart" id="month-chart"></div>
            </div>
        </div>

        <div class="finance-card border-green">
            <div class="label" style="color: var(--neon-green);">System Projection // Future Forecast</div>
            <div class="stat-loader" id="loader-forecast">
                <div class="loader-text blink" style="color: var(--neon-green);">CALCULATING_PROJECTIONS...</div>
                <div class="loader-track"><div class="loader-fill" style="--bar-color: var(--neon-green); --load-time: 1.5s;"></div></div>
            </div>
            <div class="stat-content" id="content-forecast">
                <div id="val-forecast" class="value">0 €</div>
                <div class="sub-info"><span id="count-forecast">0 Anstehende Buchungen</span><span>Erwartet</span></div>
            </div>
        </div>

        <div class="finance-card border-cyan">
            <div class="label">Revenue Data Stream // Categories</div>
            <div class="stat-loader" id="loader-stream">
                <div class="loader-text blink">SPLITTING_DATA_CHANNELS...</div>
                <div class="loader-track"><div class="loader-fill" style="--bar-color: var(--neon-cyan); --load-time: 2.5s;"></div></div>
            </div>
            <div class="stat-content" id="content-stream">
                <div class="progress-container" id="category-stream"></div>
            </div>
        </div>

        <div class="grid-2">
            <div class="finance-card" style="border-left: 4px solid #fff; text-align: center;">
                <div class="label">Success Rate</div>
                <div class="stat-loader" id="loader-matrix1">
                    <div class="loader-text blink" style="color: #fff;">EVALUATING...</div>
                    <div class="loader-track"><div class="loader-fill" style="--bar-color: #fff; --load-time: 2.8s;"></div></div>
                </div>
                <div class="stat-content" id="content-matrix1">
                    <div id="val-success" class="value" style="font-size: 1.8rem;">0%</div>
                </div>
            </div>
            
            <div class="finance-card" style="border-left: 4px solid var(--neon-red); text-align: center;">
                <div class="label" style="color: var(--neon-red);">No-Show Rate</div>
                <div class="stat-loader" id="loader-matrix2">
                    <div class="loader-text blink" style="color: var(--neon-red);">SCANNING_STRIKES...</div>
                    <div class="loader-track"><div class="loader-fill" style="--bar-color: var(--neon-red); --load-time: 2.8s;"></div></div>
                </div>
                <div class="stat-content" id="content-matrix2">
                    <div id="val-noshow" class="value" style="font-size: 1.8rem; color: var(--neon-red);">0%</div>
                </div>
            </div>
        </div>

        <div class="terminal">
            <div class="terminal-content" id="terminal-logs"></div>
        </div>

    </div>

    <script>
        // GLOBAL DATA OBJECT
        let calculatedValues = {};

        // J.A.R.V.I.S. Terminal Simulator
        const logs = [
            "Initializing deep scan of local storage...",
            "Decrypting 'appTermine' sector...",
            "Cross-referencing revenue entries...",
            "Calculating monthly breakdown algorithms...",
            "Compiling category data streams...",
            "System metrics stable. Visualizing..."
        ];
        
        function runTerminal() {
            const term = document.getElementById('terminal-logs');
            let delay = 0;
            logs.forEach((log, index) => {
                setTimeout(() => {
                    const p = document.createElement('div');
                    p.className = 'log-line';
                    p.innerText = `> ${log}`;
                    term.appendChild(p);
                    if (index === logs.length - 1) {
                        setTimeout(() => {
                            term.innerHTML += `<div class="log-line" style="color: #fff; margin-top: 10px;">> AWAITING COMMAND <span class="blink">_</span></div>`;
                        }, 800);
                    }
                }, delay);
                delay += 400 + Math.random() * 300; 
            });
        }

        // 1. PHASE: Alles berechnen (aber noch nicht anzeigen)
        function calculateStats() {
            const termine = JSON.parse(localStorage.getItem('appTermine')) || [];
            const settings = JSON.parse(localStorage.getItem('appEinstellungen')) || { kat1_name: 'VIP', kat2_name: 'Stamm', kat3_name: 'Neu' };
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            
            let revW = 0, countW = 0;
            let revM = 0, countM = 0;
            let revY = 0, countY = 0;
            let revFuture = 0, countFuture = 0;
            let noShows = 0, completed = 0;
            let monthlyRev = new Array(12).fill(0);

            let catData = {
                kat1: { name: settings.kat1_name, color: 'var(--neon-gold)', amount: 0 },
                kat2: { name: settings.kat2_name, color: 'var(--neon-pink)', amount: 0 },
                kat3: { name: settings.kat3_name, color: 'var(--neon-cyan)', amount: 0 }
            };

            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            
            const getWeek = (d) => {
                const date = new Date(d.getTime());
                date.setHours(0, 0, 0, 0);
                date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
                const week1 = new Date(date.getFullYear(), 0, 4);
                return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
            };
            const currentWeek = getWeek(now);

            termine.forEach(t => {
                if(!t.datum) return;
                const tDate = new Date(t.datum);
                const tYear = tDate.getFullYear();
                const tMonth = tDate.getMonth(); 
                const tWeek = getWeek(tDate);
                
                let price = 0;
                if (t.status === 'done' && t.umsatz) price = parseFloat(t.umsatz);
                else if (t.preis) price = parseFloat(t.preis);
                else if (settings[t.kat + "_preis"]) price = parseFloat(settings[t.kat + "_preis"]);

                if (t.status === 'noshow') noShows++;
                if (t.status === 'done') completed++;

                if (t.datum > todayStr && t.status !== 'noshow') {
                    revFuture += price; countFuture++;
                }

                if (t.status === 'done' && tYear === currentYear) {
                    revY += price; countY++;
                    if (catData[t.kat]) catData[t.kat].amount += price;
                    monthlyRev[tMonth] += price;
                    if(tMonth === currentMonth) { revM += price; countM++; }
                    if(tWeek === currentWeek) { revW += price; countW++; }
                }
            });

            const totalPast = completed + noShows;
            let successRate = 0, noshowRate = 0;
            if (totalPast > 0) {
                successRate = Math.round((completed / totalPast) * 100);
                noshowRate = Math.round((noShows / totalPast) * 100);
            }

            // Speichert alles ins globale Objekt
            calculatedValues = {
                revW, revM, revY, revFuture,
                countW, countM, countY, countFuture,
                successRate, noshowRate,
                catData, monthlyRev, currentYear
            };

            // Setzt feste Texte (die schon beim Laden da sein können)
            document.getElementById('current-year').innerText = currentYear;
            document.getElementById('count-week').innerText = countW + " Termine";
            document.getElementById('count-month').innerText = countM + " Termine";
            document.getElementById('count-year').innerText = countY + " Termine";
            document.getElementById('count-forecast').innerText = countFuture + " Buchungen";
        }

        // 2. PHASE: Eine Karte laden, umschalten & Zahl animieren
        function revealCard(id, delay, callback) {
            setTimeout(() => {
                const loader = document.getElementById('loader-' + id);
                const content = document.getElementById('content-' + id);
                if(loader && content) {
                    loader.style.display = 'none';
                    content.style.display = 'block';
                    content.classList.add('fade-in');
                    if(typeof callback === 'function') callback();
                }
            }, delay);
        }

        // Zähler hochzählen lassen (Matrix Style)
        function animateValue(id, endValue) {
            const obj = document.getElementById(id);
            let start = 0;
            const duration = 1200;
            const increment = endValue / (duration / 16); 
            
            function update() {
                start += increment;
                if (start >= endValue) {
                    obj.innerText = endValue.toFixed(2).replace('.00', '') + " €";
                } else {
                    obj.innerText = start.toFixed(2).replace('.00', '') + " €";
                    requestAnimationFrame(update);
                }
            }
            if(endValue > 0) update();
            else obj.innerText = "0 €";
        }

        function renderMonthChart() {
            const monthChartBox = document.getElementById('month-chart');
            monthChartBox.innerHTML = '';
            const monthlyRev = calculatedValues.monthlyRev;
            const maxMonthAmount = Math.max(...monthlyRev, 1); 
            const monthNames = ['J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D'];
            const currentMonth = new Date().getMonth();
            
            monthlyRev.forEach((val, idx) => {
                const percentage = Math.round((val / maxMonthAmount) * 100);
                let valDisplay = val > 0 ? val + "€" : ""; 
                let isCurrent = (idx === currentMonth) ? 'color: var(--neon-cyan);' : '';

                monthChartBox.innerHTML += `
                    <div class="month-col">
                        <div class="month-val">${valDisplay}</div>
                        <div class="month-bar" data-height="${percentage}%"></div>
                        <div class="month-label" style="${isCurrent}">${monthNames[idx]}</div>
                    </div>
                `;
            });

            setTimeout(() => {
                document.querySelectorAll('.month-bar').forEach(bar => bar.style.height = bar.getAttribute('data-height'));
                document.querySelectorAll('.month-val').forEach(val => val.style.opacity = '1');
            }, 50);
        }

        function renderCategoryStream() {
            const streamBox = document.getElementById('category-stream');
            streamBox.innerHTML = '';
            const catData = calculatedValues.catData;
            let maxCatAmount = Math.max(catData.kat1.amount, catData.kat2.amount, catData.kat3.amount, 1);

            Object.keys(catData).forEach(k => {
                const c = catData[k];
                const percentage = Math.round((c.amount / maxCatAmount) * 100);
                
                streamBox.innerHTML += `
                    <div class="progress-row">
                        <div class="progress-name" style="color: ${c.color}">${c.name}</div>
                        <div class="progress-track">
                            <div class="progress-fill-data" style="background: ${c.color}; box-shadow: 0 0 10px ${c.color};" data-width="${percentage}%"></div>
                        </div>
                        <div class="progress-value">${c.amount}€</div>
                    </div>
                `;
            });

            setTimeout(() => {
                document.querySelectorAll('.progress-fill-data').forEach(bar => bar.style.width = bar.getAttribute('data-width'));
            }, 50);
        }

        // 3. START-SEQUENZ
        window.onload = () => {
            calculateStats(); // Daten berechnen
            
            setTimeout(() => {
                const mainLoader = document.getElementById('app-loader');
                mainLoader.style.opacity = '0'; 
                
                setTimeout(() => {
                    mainLoader.remove(); 
                    runTerminal(); // Terminal sofort starten
                    
                    // LADE-BALKEN SEQUENZ STARTEN (Passend zu --load-time)
                    revealCard('week', 800, () => animateValue('val-week', calculatedValues.revW));
                    revealCard('month', 1200, () => animateValue('val-month', calculatedValues.revM));
                    revealCard('forecast', 1500, () => animateValue('val-forecast', calculatedValues.revFuture));
                    revealCard('year', 1800, () => animateValue('val-year', calculatedValues.revY));
                    
                    revealCard('chart', 2200, () => renderMonthChart());
                    revealCard('stream', 2500, () => renderCategoryStream());
                    
                    revealCard('matrix1', 2800, () => { document.getElementById('val-success').innerText = calculatedValues.successRate + "%"; });
                    revealCard('matrix2', 2800, () => { document.getElementById('val-noshow').innerText = calculatedValues.noshowRate + "%"; });

                }, 400); 
            }, 500); 
        };
    </script>
</body>
</html>
