<!DOCTYPE html>
<html lang="de">
<head>
    <script>
        // H√ÑRTESTER T√úRSTEHER DER WELT
        if (!sessionStorage.getItem('authKey')) {
            window.location.replace('index.html');
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agenda 2050 | Setup</title>
    <link rel="stylesheet" href="style.css">
    <script src="app.js" defer></script>
</head>
<body>

    <div class="loader-container" id="app-loader">
        <div class="cyber-spinner"></div>
        <div class="loader-text">ACCESSING CONFIG...</div>
    </div>

    <div class="dashboard">
        <div class="btn-cyber btn-settings" onclick="location.href='woche.html'">‚¨ÖÔ∏è</div>
        
        <div class="header-info">
            <div class="titel-neon">Setup</div>
            <div class="countdown-pulsing">System-Konfiguration</div>
        </div>
        
        <div style="width: 60px; height: 60px;"></div>
    </div>

    <div class="settings-container">
        
        <div class="settings-card">
            <div class="setting-title">Sicherheits-Protokoll (PIN)</div>
            <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 20px;">√Ñndere den Zugangscode f√ºr die App (Standard: 0000).</p>
            <div style="display: flex; gap: 15px;">
                <div class="form-group" style="flex: 1;">
                    <label class="input-label">Aktuelle PIN</label>
                    <input type="password" id="oldPin" class="cyber-input-full" placeholder="****" inputmode="numeric">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label class="input-label">Neue PIN</label>
                    <input type="password" id="newPin" class="cyber-input-full" placeholder="4 Ziffern" inputmode="numeric">
                </div>
            </div>
            <button onclick="changeSystemPin()" class="btn-save" style="margin-top: 10px; padding: 15px; font-size: 1rem;">PIN Aktualisieren</button>
        </div>

        <div class="settings-card">
            <div class="setting-title">Zeit-Matrix (Arbeitszeit)</div>
            <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 20px;">Definiert die Breite der Timeline in der Wochen- und Tagesansicht.</p>
            <div style="display: flex; gap: 15px;">
                <div class="form-group" style="flex: 1;">
                    <label class="input-label">Tagesbeginn</label>
                    <input type="time" id="arbeitsStart" class="cyber-input-full">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label class="input-label">Tagesende</label>
                    <input type="time" id="arbeitsEnde" class="cyber-input-full">
                </div>
            </div>
        </div>

        <div class="settings-card">
            <div class="setting-title">Kategorie-Verschl√ºsselung</div>
            
            <div class="kat-setup-row">
                <input type="color" id="kat1_farbe" class="cyber-color">
                <div style="flex-grow:1;">
                    <label class="input-label">Kategorie 1 (z.B. VIP)</label>
                    <input type="text" id="kat1_name" class="cyber-input-full">
                </div>
            </div>

            <div class="kat-setup-row">
                <input type="color" id="kat2_farbe" class="cyber-color">
                <div style="flex-grow:1;">
                    <label class="input-label">Kategorie 2 (z.B. Stamm)</label>
                    <input type="text" id="kat2_name" class="cyber-input-full">
                </div>
            </div>

            <div class="kat-setup-row">
                <input type="color" id="kat3_farbe" class="cyber-color">
                <div style="flex-grow:1;">
                    <label class="input-label">Kategorie 3 (z.B. Neu)</label>
                    <input type="text" id="kat3_name" class="cyber-input-full">
                </div>
            </div>
        </div>

        <div class="settings-card">
            <div class="setting-title">Kommunikations-Kan√§le</div>
            <div class="form-group">
                <label class="input-label">Plattform 1</label>
                <input type="text" id="plat1" class="cyber-input-full">
            </div>
            <div class="form-group">
                <label class="input-label">Plattform 2</label>
                <input type="text" id="plat2" class="cyber-input-full">
            </div>
            <div class="form-group">
                <label class="input-label">Plattform 3</label>
                <input type="text" id="plat3" class="cyber-input-full">
            </div>
            <div class="form-group">
                <label class="input-label">Plattform 4</label>
                <input type="text" id="plat4" class="cyber-input-full">
            </div>
        </div>

        <div class="settings-card">
            <div class="setting-title" style="color: var(--neon-gold); border-bottom-color: rgba(229, 176, 92, 0.3);">Daten-Management (Offline-Sync)</div>
            <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 20px;">Sichere deine gesamte Datenbank lokal als Datei oder spiele ein bestehendes Backup ein.</p>
            
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <button class="btn-save" onclick="exportDatabase()" style="flex: 1; padding: 15px; font-size: 1rem;">üíæ Backup laden</button>
                <button class="btn-save" onclick="document.getElementById('importFile').click()" style="flex: 1; background: rgba(229, 176, 92, 0.1); border-color: var(--neon-gold); color: var(--neon-gold); padding: 15px; font-size: 1rem;">üìÇ Daten einspielen</button>
            </div>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importDatabase(event)">
        </div>

        <button class="btn-save" id="save-btn" onclick="saveSystemSettings()">KONFIGURATION SPEICHERN</button>
        
        <button onclick="location.href='woche.html'" style="width: 100%; background: none; border: none; color: #555; font-size: 1rem; padding: 20px; text-transform: uppercase; cursor: pointer; letter-spacing: 2px;">Abbrechen</button>

        <div class="danger-zone">
            <div class="danger-title">Danger Zone</div>
            <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 20px;">L√∂scht unwiderruflich alle Termine. (Kundendaten bleiben erhalten).</p>
            <button class="btn-danger" onclick="resetAllData()">Alle Termine l√∂schen</button>
        </div>
    </div>

    <script>
        window.addEventListener('load', () => {
            const saved = localStorage.getItem('appEinstellungen');
            const d = {
                arbeitsStart: '08:00',
                arbeitsEnde: '22:00',
                kat1_name: 'VIP', kat1_farbe: '#e5b05c',
                kat2_name: 'Stamm', kat2_farbe: '#ff2a6d',
                kat3_name: 'Neu', kat3_farbe: '#05d9e8',
                plat1: 'WhatsApp', plat2: 'Instagram', plat3: 'Telegram', plat4: 'Telefon'
            };
            
            const s = saved ? JSON.parse(saved) : d;

            document.getElementById('arbeitsStart').value = s.arbeitsStart || d.arbeitsStart;
            document.getElementById('arbeitsEnde').value = s.arbeitsEnde || d.arbeitsEnde;

            document.getElementById('kat1_name').value = s.kat1_name || d.kat1_name;
            document.getElementById('kat1_farbe').value = s.kat1_farbe || d.kat1_farbe;
            document.getElementById('kat2_name').value = s.kat2_name || d.kat2_name;
            document.getElementById('kat2_farbe').value = s.kat2_farbe || d.kat2_farbe;
            document.getElementById('kat3_name').value = s.kat3_name || d.kat3_name;
            document.getElementById('kat3_farbe').value = s.kat3_farbe || d.kat3_farbe;
            
            document.getElementById('plat1').value = s.plat1 || d.plat1;
            document.getElementById('plat2').value = s.plat2 || d.plat2;
            document.getElementById('plat3').value = s.plat3 || d.plat3;
            document.getElementById('plat4').value = s.plat4 || d.plat4;

            setTimeout(() => {
                const loader = document.getElementById('app-loader');
                if(loader) { loader.style.opacity = '0'; setTimeout(() => loader.remove(), 500); }
            }, 400);
        });

        function changeSystemPin() {
            const oldInput = document.getElementById('oldPin').value;
            const newInput = document.getElementById('newPin').value;
            const currentPin = localStorage.getItem('appPin') || "0000";

            if (oldInput !== currentPin) {
                alert("‚ùå Die aktuelle PIN ist falsch!");
                return;
            }
            if (newInput.length !== 4) {
                alert("‚ö†Ô∏è Die neue PIN muss genau 4 Ziffern lang sein!");
                return;
            }

            localStorage.setItem('appPin', newInput);
            alert("‚úÖ System-PIN wurde erfolgreich aktualisiert!");
            document.getElementById('oldPin').value = '';
            document.getElementById('newPin').value = '';
        }

        function saveSystemSettings() {
            const btn = document.getElementById('save-btn');
            btn.innerText = "SAVING...";
            
            const newSettings = {
                arbeitsStart: document.getElementById('arbeitsStart').value || '08:00',
                arbeitsEnde: document.getElementById('arbeitsEnde').value || '22:00',
                kat1_name: document.getElementById('kat1_name').value,
                kat1_farbe: document.getElementById('kat1_farbe').value,
                kat2_name: document.getElementById('kat2_name').value,
                kat2_farbe: document.getElementById('kat2_farbe').value,
                kat3_name: document.getElementById('kat3_name').value,
                kat3_farbe: document.getElementById('kat3_farbe').value,
                plat1: document.getElementById('plat1').value,
                plat2: document.getElementById('plat2').value,
                plat3: document.getElementById('plat3').value,
                plat4: document.getElementById('plat4').value
            };

            localStorage.setItem('appEinstellungen', JSON.stringify(newSettings));
            
            btn.style.background = "var(--neon-green)";
            btn.style.color = "#000";
            btn.innerText = "SYSTEM UPDATED!";
            
            setTimeout(() => { location.href = 'woche.html'; }, 800);
        }

        function resetAllData() {
            if(confirm("SYSTEMWARNUNG: Alle TERMINE werden unwiderruflich gel√∂scht! (Kunden bleiben erhalten)")) {
                const btn = document.querySelector('.btn-danger');
                if(btn) {
                    btn.innerText = "L√ñSCHEN L√ÑUFT...";
                    btn.style.opacity = "0.7";
                }
                
                localStorage.setItem('appTermine', JSON.stringify([]));
                
                setTimeout(() => {
                    window.location.href = 'woche.html';
                }, 1500);
            }
        }

        // --- NEU: DATENBANK EXPORTIEREN (BACKUP) ---
        function exportDatabase() {
            const backupData = {
                termine: JSON.parse(localStorage.getItem('appTermine')) || [],
                kunden: JSON.parse(localStorage.getItem('appKunden')) || [],
                einstellungen: JSON.parse(localStorage.getItem('appEinstellungen')) || {},
                exportDate: new Date().toISOString()
            };

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData));
            const downloadAnchorNode = document.createElement('a');
            
            // Formatierter Dateiname mit Datum (z.B. agenda2050_backup_27-02-2026.json)
            const dateStr = new Date().toLocaleDateString('de-DE').replace(/\./g, '-');
            
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `agenda2050_backup_${dateStr}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // --- NEU: DATENBANK IMPORTIEREN (RESTORE) ---
        function importDatabase(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (confirm("SYSTEM-WARNUNG: M√∂chtest du deine aktuellen Daten wirklich mit diesem Backup √ºberschreiben?")) {
                        
                        if (importedData.termine) localStorage.setItem('appTermine', JSON.stringify(importedData.termine));
                        if (importedData.kunden) localStorage.setItem('appKunden', JSON.stringify(importedData.kunden));
                        if (importedData.einstellungen) localStorage.setItem('appEinstellungen', JSON.stringify(importedData.einstellungen));
                        
                        alert("‚úÖ SYNC ERFOLGREICH: Alle Daten wurden wiederhergestellt!");
                        location.reload(); // Seite neu laden, damit die importierten Einstellungen sofort sichtbar werden
                    }
                } catch (err) {
                    alert("‚ùå FEHLER: Ung√ºltige oder besch√§digte Backup-Datei!");
                }
                // Input Feld zur√ºcksetzen, damit man die gleiche Datei noch mal ausw√§hlen kann
                event.target.value = ''; 
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
