<!DOCTYPE html>
<html lang="de">
<head>
    <script>
        if (!sessionStorage.getItem('authKey')) {
            window.location.replace('index.html');
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agenda 2050 | Finance Core</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .stats-container { padding: 20px; display: flex; flex-direction: column; gap: 20px; padding-bottom: 50px; }
        
        /* Jarvis-Style Cards */
        .finance-card {
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            padding: 20px; border-radius: 15px; position: relative; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .finance-card::after {
            content: ""; position: absolute; top: 0; right: 0; width: 60px; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.03));
            transform: skewX(-45deg) translateX(50px);
        }

        .border-cyan { border-left: 4px solid var(--neon-cyan); }
        .border-violet { border-left: 4px solid var(--neon-violet); }
        .border-gold { border-left: 4px solid var(--neon-gold); }
        .border-green { border-left: 4px solid var(--neon-green); }

        .label { font-size: 0.75rem; color: #aaa; text-transform: uppercase; letter-spacing: 2px; font-weight: bold; }
        .label-highlight { color: var(--neon-cyan); }
        .value { font-size: 2.2rem; font-weight: 900; color: white; margin-top: 5px; text-shadow: 0 0 15px rgba(255,255,255,0.2); font-family: monospace; }
        .sub-info { font-size: 0.85rem; color: #888; margin-top: 10px; border-top: 1px dashed rgba(255,255,255,0.1); padding-top: 10px; display: flex; justify-content: space-between; }
        
        /* Grid Layouts */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        /* NEU: Boot-Animation (Stufenweises Laden) */
        .anim-element { opacity: 0; transform: translateY(30px); }
        .system-loaded .anim-element { animation: bootUp 0.6s cubic-bezier(0.1, 0.8, 0.2, 1) forwards; }
        @keyframes bootUp { to { opacity: 1; transform: translateY(0); } }
        
        .delay-1 { animation-delay: 0.1s; }
        .delay-2 { animation-delay: 0.2s; }
        .delay-3 { animation-delay: 0.3s; }
        .delay-4 { animation-delay: 0.4s; }
        .delay-5 { animation-delay: 0.5s; }
        .delay-6 { animation-delay: 0.6s; }

        /* Progress Bars (Data Stream) */
        .progress-container { margin-top: 15px; }
        .progress-row { display: flex; align-items: center; margin-bottom: 10px; font-size: 0.85rem; color: #ccc; }
        .progress-name { width: 60px; text-transform: uppercase; font-weight: bold; }
        .progress-track { flex-grow: 1; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; margin: 0 10px; }
        .progress-fill { height: 100%; border-radius: 4px; width: 0%; transition: width 1.5s cubic-bezier(0.1, 0.8, 0.2, 1); }
        .progress-value { width: 50px; text-align: right; font-family: monospace; color: white; }

        /* NEU: Monthly Breakdown Chart */
        .month-chart { display: flex; justify-content: space-between; align-items: flex-end; height: 120px; margin-top: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; gap: 4px; }
        .month-col { flex: 1; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; height: 100%; position: relative; }
        .month-bar { width: 100%; max-width: 15px; background: var(--neon-violet); border-radius: 3px 3px 0 0; transition: height 1.5s cubic-bezier(0.1, 0.8, 0.2, 1); height: 0; box-shadow: 0 0 10px rgba(188, 0, 221, 0.4); }
        .month-label { font-size: 0.6rem; color: #888; margin-top: 8px; text-transform: uppercase; font-weight: bold; }
        .month-val { font-size: 0.55rem; color: white; margin-bottom: 4px; font-family: monospace; opacity: 0; transition: opacity 1s; position: absolute; top: -20px; text-shadow: 0 0 5px rgba(255,255,255,0.5); }

        /* Terminal Window */
        .terminal {
            background: rgba(5, 15, 25, 0.9); border: 1px solid var(--neon-cyan);
            border-radius: 10px; padding: 15px; font-family: monospace; font-size: 0.8rem;
            color: var(--neon-cyan); box-shadow: inset 0 0 20px rgba(5, 217, 232, 0.1);
            height: 120px; overflow: hidden; position: relative;
        }
        .terminal::before {
            content: "SYSTEM_LOG // ANALYSIS"; position: absolute; top: 0; left: 0; width: 100%;
            background: var(--neon-cyan); color: black; padding: 2px 10px; font-weight: bold; font-size: 0.7rem;
        }
        .terminal-content { margin-top: 15px; display: flex; flex-direction: column; gap: 5px; }
        .log-line { opacity: 0; animation: fadeInLog 0.2s forwards; }
        @keyframes fadeInLog { to { opacity: 1; } }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }

    </style>
</head>
<body>

    <div class="loader-container" id="app-loader">
        <div class="cyber-spinner"></div>
        <div class="loader-text">BOOTING FINANCE_CORE...</div>
    </div>

    <div class="dashboard">
        <div class="btn-cyber" onclick="location.href='woche.html'">⬅️</div>
        <div class="header-info">
            <div class="titel-neon">FINANCE_CORE</div>
            <div class="datum-anzeige" id="sys-status" style="color: var(--neon-cyan); text-shadow: 0 0 10px var(--neon-cyan);">SYSTEM ONLINE</div>
        </div>
        <div></div>
    </div>

    <div class="stats-container" id="main-container">
        
        <div class="grid-2">
            <div class="finance-card border-cyan anim-element delay-1">
                <div class="label label-highlight">Current Week</div>
                <div id="val-week" class="value">0 €</div>
                <div class="sub-info"><span id="count-week">0 Termine</span><span style="color:var(--neon-cyan);">LIVE</span></div>
            </div>
            <div class="finance-card border-violet anim-element delay-1">
                <div class="label" style="color: var(--neon-violet);">Current Month</div>
                <div id="val-month" class="value">0 €</div>
                <div class="sub-info"><span id="count-month">0 Termine</span></div>
            </div>
        </div>

        <div class="finance-card border-gold anim-element delay-2" style="background: rgba(229, 176, 92, 0.05);">
            <div class="label" style="color: var(--neon-gold);">Total Revenue <span id="current-year"></span></div>
            <div id="val-year" class="value" style="font-size: 3rem; text-shadow: 0 0 20px rgba(229,176,92,0.4);">0 €</div>
            <div class="sub-info"><span id="count-year">0 Abgeschlossen</span></div>
        </div>

        <div class="finance-card border-violet anim-element delay-3">
            <div class="label" style="color: var(--neon-violet);">Monthly Breakdown // Analyse</div>
            <div class="month-chart" id="month-chart">
                </div>
        </div>

        <div class="finance-card border-green anim-element delay-4">
            <div class="label" style="color: var(--neon-green);">System Projection // Future Forecast</div>
            <div id="val-forecast" class="value">0 €</div>
            <div class="sub-info"><span id="count-forecast">0 Anstehende Buchungen</span><span>Erwartet</span></div>
        </div>

        <div class="finance-card anim-element delay-5 border-cyan">
            <div class="label">Revenue Data Stream // Categories</div>
            <div class="progress-container" id="category-stream">
                </div>
        </div>

        <div class="grid-2 anim-element delay-6">
            <div class="finance-card" style="border-left: 4px solid #fff; text-align: center;">
                <div class="label">Success Rate</div>
                <div id="val-success" class="value" style="font-size: 1.8rem;">0%</div>
            </div>
            <div class="finance-card" style="border-left: 4px solid var(--neon-red); text-align: center;">
                <div class="label" style="color: var(--neon-red);">No-Show Rate</div>
                <div id="val-noshow" class="value" style="font-size: 1.8rem; color: var(--neon-red);">0%</div>
            </div>
        </div>

        <div class="terminal anim-element delay-6">
            <div class="terminal-content" id="terminal-logs"></div>
        </div>

    </div>

    <script>
        // J.A.R.V.I.S. Terminal Simulator
        const logs = [
            "Initializing deep scan of local storage...",
            "Decrypting 'appTermine' sector...",
            "Cross-referencing revenue entries...",
            "Calculating monthly breakdown algorithms...",
            "Compiling category data streams...",
            "System metrics stable. Visualizing..."
        ];
        
        function runTerminal() {
            const term = document.getElementById('terminal-logs');
            let delay = 0;
            logs.forEach((log, index) => {
                setTimeout(() => {
                    const p = document.createElement('div');
                    p.className = 'log-line';
                    p.innerText = `> ${log}`;
                    term.appendChild(p);
                    if (index === logs.length - 1) {
                        setTimeout(() => {
                            term.innerHTML += `<div class="log-line" style="color: #fff; margin-top: 10px;">> AWAITING COMMAND <span class="blink">_</span></div>`;
                        }, 800);
                    }
                }, delay);
                delay += 400 + Math.random() * 300; 
            });
        }

        function loadStats() {
            const termine = JSON.parse(localStorage.getItem('appTermine')) || [];
            const settings = JSON.parse(localStorage.getItem('appEinstellungen')) || { kat1_name: 'VIP', kat2_name: 'Stamm', kat3_name: 'Neu' };
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            
            let revW = 0, countW = 0;
            let revM = 0, countM = 0;
            let revY = 0, countY = 0;
            let revFuture = 0, countFuture = 0;

            let noShows = 0;
            let completed = 0;

            // NEU: Array für den Monatsverlauf (12 Monate)
            let monthlyRev = new Array(12).fill(0);

            let catData = {
                kat1: { name: settings.kat1_name, color: 'var(--neon-gold)', amount: 0 },
                kat2: { name: settings.kat2_name, color: 'var(--neon-pink)', amount: 0 },
                kat3: { name: settings.kat3_name, color: 'var(--neon-cyan)', amount: 0 }
            };

            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            
            const getWeek = (d) => {
                const date = new Date(d.getTime());
                date.setHours(0, 0, 0, 0);
                date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
                const week1 = new Date(date.getFullYear(), 0, 4);
                return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
            };
            const currentWeek = getWeek(now);

            termine.forEach(t => {
                if(!t.datum) return;
                const tDate = new Date(t.datum);
                const tYear = tDate.getFullYear();
                const tMonth = tDate.getMonth(); // 0 = Jan, 11 = Dez
                const tWeek = getWeek(tDate);
                
                let price = 0;
                if (t.status === 'done' && t.umsatz) {
                    price = parseFloat(t.umsatz);
                } else if (t.preis) {
                    price = parseFloat(t.preis);
                } else if (settings[t.kat + "_preis"]) {
                    price = parseFloat(settings[t.kat + "_preis"]);
                }

                if (t.status === 'noshow') noShows++;
                if (t.status === 'done') completed++;

                // ZUKUNFT
                if (t.datum > todayStr && t.status !== 'noshow') {
                    revFuture += price;
                    countFuture++;
                }

                // VERGANGENHEIT (Aktuelles Jahr)
                if (t.status === 'done' && tYear === currentYear) {
                    revY += price; 
                    countY++;
                    
                    if (catData[t.kat]) catData[t.kat].amount += price;
                    
                    // In den Monats-Array eintragen
                    monthlyRev[tMonth] += price;

                    if(tMonth === currentMonth) { revM += price; countM++; }
                    if(tWeek === currentWeek) { revW += price; countW++; }
                }
            });

            // UI UPDATES ZIEL-WERTE
            document.getElementById('current-year').innerText = currentYear;

            // Zähler Animation starten
            animateValue('val-week', revW);
            animateValue('val-month', revM);
            animateValue('val-year', revY);
            animateValue('val-forecast', revFuture);

            document.getElementById('count-week').innerText = countW + " Termine";
            document.getElementById('count-month').innerText = countM + " Termine";
            document.getElementById('count-year').innerText = countY + " Termine";
            document.getElementById('count-forecast').innerText = countFuture + " Buchungen";

            // Performance Rates
            const totalPast = completed + noShows;
            let successRate = 0, noshowRate = 0;
            if (totalPast > 0) {
                successRate = Math.round((completed / totalPast) * 100);
                noshowRate = Math.round((noShows / totalPast) * 100);
            }
            document.getElementById('val-success').innerText = successRate + "%";
            document.getElementById('val-noshow').innerText = noshowRate + "%";

            // 1. NEU: Monthly Breakdown rendern
            const monthChartBox = document.getElementById('month-chart');
            monthChartBox.innerHTML = '';
            const maxMonthAmount = Math.max(...monthlyRev, 1); // Höchster Monatswert (mindestens 1)
            const monthNames = ['J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D'];
            
            monthlyRev.forEach((val, idx) => {
                const percentage = Math.round((val / maxMonthAmount) * 100);
                let valDisplay = val > 0 ? val + "€" : ""; // Wert nur anzeigen, wenn > 0
                let isCurrent = (idx === currentMonth) ? 'color: var(--neon-cyan);' : '';

                monthChartBox.innerHTML += `
                    <div class="month-col">
                        <div class="month-val">${valDisplay}</div>
                        <div class="month-bar" data-height="${percentage}%"></div>
                        <div class="month-label" style="${isCurrent}">${monthNames[idx]}</div>
                    </div>
                `;
            });

            // 2. Category Stream rendern
            const streamBox = document.getElementById('category-stream');
            streamBox.innerHTML = '';
            let maxCatAmount = Math.max(catData.kat1.amount, catData.kat2.amount, catData.kat3.amount, 1);

            Object.keys(catData).forEach(k => {
                const c = catData[k];
                const percentage = Math.round((c.amount / maxCatAmount) * 100);
                
                streamBox.innerHTML += `
                    <div class="progress-row">
                        <div class="progress-name" style="color: ${c.color}">${c.name}</div>
                        <div class="progress-track">
                            <div class="progress-fill" style="background: ${c.color}; box-shadow: 0 0 10px ${c.color};" data-width="${percentage}%"></div>
                        </div>
                        <div class="progress-value">${c.amount}€</div>
                    </div>
                `;
            });

            // Nach kurzer Verzögerung die Balken-Animationen für Kategorien und Monate starten
            setTimeout(() => {
                document.querySelectorAll('.progress-fill').forEach(bar => {
                    bar.style.width = bar.getAttribute('data-width');
                });
                document.querySelectorAll('.month-bar').forEach(bar => {
                    bar.style.height = bar.getAttribute('data-height');
                });
                document.querySelectorAll('.month-val').forEach(val => {
                    val.style.opacity = '1';
                });
            }, 800); // Wartet auf die Lade-Animation
        }

        // Zähler hochzählen lassen
        function animateValue(id, endValue) {
            const obj = document.getElementById(id);
            let start = 0;
            const duration = 1200;
            const increment = endValue / (duration / 16); 
            
            function update() {
                start += increment;
                if (start >= endValue) {
                    obj.innerText = endValue.toFixed(2).replace('.00', '') + " €";
                } else {
                    obj.innerText = start.toFixed(2).replace('.00', '') + " €";
                    requestAnimationFrame(update);
                }
            }
            if(endValue > 0) update();
            else obj.innerText = "0 €";
        }

        window.onload = () => {
            loadStats();
            
            // SYSTEM BOOT SCRIPT
            setTimeout(() => {
                const loader = document.getElementById('app-loader');
                loader.style.opacity = '0'; // Blendet den Text "BOOTING..." aus
                
                setTimeout(() => {
                    loader.remove(); // Entfernt den schwarzen Screen
                    
                    // STARTET DIE KASKADE (Karten laden nacheinander)
                    document.getElementById('main-container').classList.add('system-loaded');
                    
                    // STARTET DEN TERMINAL TEXT
                    runTerminal(); 
                }, 400); // Kurze Pause nach dem Ausblenden
            }, 800); // Initiale Boot-Dauer
        };
    </script>
</body>
</html>
