<!DOCTYPE html>
<html lang="de">
<head>
    <script>
        if (!sessionStorage.getItem('authKey')) {
            window.location.replace('index.html');
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agenda 2050 | Tagesansicht</title>
    <link rel="stylesheet" href="style.css">
    <script src="app.js" defer></script>
</head>
<body>

    <div class="loader-container" id="app-loader">
        <div class="cyber-spinner"></div>
        <div class="loader-text">SYNCING DATA...</div>
    </div>

    <div class="dashboard">
        <div class="btn-cyber btn-settings" onclick="location.href='woche.html'">‚¨ÖÔ∏è</div>
        <div class="header-info">
            <div class="titel-neon">Tagesprotokoll</div>
            <div class="datum-anzeige" id="tagesDatum">Lade...</div>
        </div>
        <div class="btn-cyber btn-add" onclick="openModal()">+</div>
    </div>

    <div class="tag-detail-container">
        <div id="timeline-container" class="vertical-timeline">
            </div>
    </div>

    <div class="modal-overlay" id="terminModal">
        <div class="modal-content">
            <div class="form-title">Protokoll Eintrag</div>
            
            <div class="form-group">
                <label>Kunde / Alias</label>
                <input type="text" id="terminName" class="cyber-input-full" placeholder="Identifikation...">
            </div>

            <div style="display: flex; gap: 15px;">
                <div class="form-group" style="flex: 1;">
                    <label>Startzeit</label>
                    <input type="time" id="terminStart" class="cyber-input-full">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Endzeit</label>
                    <input type="time" id="terminEnde" class="cyber-input-full">
                </div>
            </div>

            <div style="display: flex; gap: 15px;">
                <div class="form-group" style="flex: 1;">
                    <label>Kategorie</label>
                    <select id="terminKategorie" class="cyber-select"></select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Datum</label>
                    <input type="date" id="terminDatum" class="cyber-input-full">
                </div>
            </div>

            <div style="display: flex; gap: 15px;">
                <div class="form-group" style="flex: 1;">
                    <label>Plattform</label>
                    <select id="terminPlattform" class="cyber-select" onchange="toggleKontaktFeld()"></select>
                </div>
                <div class="form-group" id="kontaktContainer" style="flex: 1; display: none;">
                    <label>Kontakt</label>
                    <input type="text" id="terminKontakt" class="cyber-input-full" placeholder="Nummer / Link">
                </div>
            </div>

            <div class="form-group">
                <label>Zusatz-Infos</label>
                <textarea id="terminNotizen" class="cyber-input-full" placeholder="Ablauf, Besonderheiten..."></textarea>
            </div>

            <button class="btn-save" onclick="saveAppointment()">Eintrag Sichern</button>
            <button onclick="closeModal()" style="width: 100%; background: none; border: none; color: #555; font-size: 1rem; padding: 15px; text-transform: uppercase; cursor: pointer; letter-spacing: 2px; margin-top: 10px;">Abbrechen</button>
        </div>
    </div>

    <script>
        // Sterne-Logik f√ºr den Laptop Fix
        function getStarString(count) {
            let num = parseInt(count) || 0;
            if (num === 0) return "<span style='color: #444;'>‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>";
            let filled = "<span style='color: var(--neon-gold); text-shadow: 0 0 8px var(--neon-gold);'>" + "‚òÖ".repeat(num) + "</span>";
            let empty = "<span style='color: #333; text-shadow: none;'>" + "‚òÖ".repeat(5 - num) + "</span>";
            return filled + empty;
        }

        function renderTimeline(datumISO) {
            const container = document.getElementById('timeline-container');
            const dAnzeige = document.getElementById('tagesDatum');
            const termine = JSON.parse(localStorage.getItem('appTermine')) || [];
            
            // WICHTIG: Wir holen uns hier die Kundendatenbank, um sie mit den Terminen abzugleichen!
            const kundenDB = JSON.parse(localStorage.getItem('appKunden')) || [];
            const settings = JSON.parse(localStorage.getItem('appEinstellungen')) || {
                kat1_name: 'VIP', kat2_name: 'Stamm', kat3_name: 'Neu'
            };

            if (!datumISO) return;

            const tagesTermine = termine.filter(t => t.datum === datumISO).sort((a, b) => {
                if(a.start < b.start) return -1;
                if(a.start > b.start) return 1;
                return 0;
            });

            const dObj = new Date(datumISO);
            const wt = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
            dAnzeige.innerText = `${wt[dObj.getDay()]}, ${String(dObj.getDate()).padStart(2, '0')}.${String(dObj.getMonth() + 1).padStart(2, '0')}.`;

            if (tagesTermine.length === 0) {
                container.innerHTML = `<div class="empty-state">Keine Eintr√§ge f√ºr diesen Sektor.</div>`;
                return;
            }

            container.innerHTML = '';

            tagesTermine.forEach(t => {
                const katClass = t.kat || 'kat1';
                const fColor = `var(--color-${katClass})`;

                // DB-Abgleich: Versucht den Kunden √ºber Kontakt oder Name zu finden
                let dbKunde = null;
                if (t.kontakt && t.kontakt.trim() !== '') {
                    dbKunde = kundenDB.find(k => k.kontakt === t.kontakt);
                }
                if (!dbKunde) {
                    dbKunde = kundenDB.find(k => k.name.toLowerCase() === t.name.toLowerCase());
                }

                // Generiere Datenbank-Erweiterungen (Sterne, Vorlieben), falls gefunden
                let dbExtensionsHTML = '';
                let badgeHTML = '';

                if (dbKunde) {
                    // Status Badge (z.B. VIP)
                    if (dbKunde.status && dbKunde.status !== 'none') {
                        const statusName = settings[dbKunde.status + '_name'] || 'Status';
                        badgeHTML = `<span class="status-badge status-${dbKunde.status}" style="font-size: 0.65rem;">${statusName}</span>`;
                    }

                    const vibeStars = getStarString(dbKunde.vibe);
                    const perfStars = getStarString(dbKunde.perf);
                    const groesse = dbKunde.groesse && dbKunde.groesse !== "Unbekannt" ? dbKunde.groesse : "?";

                    // Wenn Bilder da sind, machen wir ein klickbares Kamera-Icon, das zur DB f√ºhrt
                    let fotosHTML = '';
                    if(dbKunde.bild1 || dbKunde.bild2) {
                        fotosHTML = `<span style="font-size:1.1rem; margin-left: 10px; cursor:pointer;" title="In Datenbank ansehen" onclick="event.stopPropagation(); window.location.href='kunden.html'">üì∏</span>`;
                    }

                    // Vorlieben
                    let vorliebenHTML = '';
                    if (dbKunde.vorlieben && dbKunde.vorlieben.trim() !== '') {
                        vorliebenHTML = `<div class="termin-info-notiz" style="border-left-color: var(--neon-violet); background: rgba(188, 0, 221, 0.05); margin-top: 5px;"><strong>Vorlieben:</strong> ${dbKunde.vorlieben}</div>`;
                    }

                    dbExtensionsHTML = `
                        <div class="kunden-stats-row" style="margin-top: 10px;">
                            <div class="stat-badge">üìê ${groesse}</div>
                            <div class="stat-badge">Vibe <span class="stars">${vibeStars}</span></div>
                            <div class="stat-badge">Perf <span class="stars">${perfStars}</span></div>
                            ${fotosHTML}
                        </div>
                        ${vorliebenHTML}
                    `;
                }

                const notizHTML = t.notizen ? `<div class="termin-info-notiz">${t.notizen}</div>` : '';
                const kontaktHTML = (t.plattform && t.plattform !== 'none') ? `<div class="termin-info-kontakt">${t.plattform}: ${t.kontakt || '?'}</div>` : '';

                container.innerHTML += `
                    <div class="timeline-item">
                        <div class="timeline-time">${t.start}</div>
                        <div class="timeline-dot" style="border-color: ${fColor};"></div>
                        
                        <div class="termin-karte" style="border-left-color: ${fColor}; cursor: pointer;" onclick="openModal(${t.id})">
                            <div class="slot-inhalt">
                                <div class="termin-info-name">${t.name} ${badgeHTML}</div>
                                <div class="termin-info-zeit">
                                    <span>${t.start} - ${t.ende}</span>
                                </div>
                                ${kontaktHTML}
                                ${dbExtensionsHTML}
                                ${notizHTML}
                            </div>
                            <button class="btn-delete" onclick="deleteTermin(event, ${t.id}, '${datumISO}')">‚úñ</button>
                        </div>
                    </div>
                `;
            });
        }

        function deleteTermin(event, id, datumISO) {
            event.stopPropagation();
            if (confirm("Dieses Protokoll wirklich l√∂schen?")) {
                let termine = JSON.parse(localStorage.getItem('appTermine')) || [];
                termine = termine.filter(t => t.id !== id);
                localStorage.setItem('appTermine', JSON.stringify(termine));
                renderTimeline(datumISO);
            }
        }

        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            let datum = urlParams.get('d');
            if(!datum) {
                const heute = new Date();
                datum = new Date(heute.getTime() - (heute.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
                window.history.replaceState({}, '', `?d=${datum}`);
            }
            document.getElementById('terminDatum').value = datum;
            renderTimeline(datum);

            setTimeout(() => {
                const loader = document.getElementById('app-loader');
                if (loader) { loader.style.opacity = '0'; setTimeout(() => loader.remove(), 500); }
            }, 400);
        });
    </script>
</body>
</html>
